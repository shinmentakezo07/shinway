import { z } from "@hono/zod-openapi";

export const completionsRequestSchema = z.object({
	model: z.string().openapi({
		example: "gpt-5",
	}),
	messages: z.array(
		z.object({
			role: z.string().openapi({
				example: "user",
			}),
			content: z
				.union([
					z.string().openapi({
						example: "Hello!",
					}),
					z.array(
						z.union([
							z.object({
								type: z.literal("text"),
								text: z.string(),
							}),
							z.object({
								type: z.literal("image_url"),
								image_url: z.object({
									url: z.string(),
									detail: z.enum(["low", "high", "auto"]).optional(),
								}),
							}),
						]),
					),
				])
				.nullable()
				.optional(),
			name: z.string().optional(),
			tool_call_id: z.string().optional(),
			tool_calls: z
				.array(
					z.object({
						id: z.string(),
						type: z.literal("function"),
						function: z.object({
							name: z.string(),
							arguments: z.string(),
						}),
					}),
				)
				.optional()
				.openapi({
					description:
						"A list of tool calls generated by the model in this message.",
					example: [
						{
							id: "call_abc123",
							type: "function",
							function: {
								name: "get_current_weather",
								arguments: '{"location": "Boston, MA"}',
							},
						},
					],
				}),
		}),
	),
	temperature: z
		.number()
		.nullable()
		.optional()
		.transform((val) => (val === null ? undefined : val))
		.openapi({
			example: 0.7,
		}),
	max_tokens: z
		.number()
		.nullable()
		.optional()
		.transform((val) => (val === null ? undefined : val))
		.openapi({
			example: 1000,
		}),
	top_p: z
		.number()
		.nullable()
		.optional()
		.transform((val) => (val === null ? undefined : val))
		.openapi({
			example: 0.9,
		}),
	frequency_penalty: z
		.number()
		.nullable()
		.optional()
		.transform((val) => (val === null ? undefined : val))
		.openapi({
			example: 0.0,
		}),
	presence_penalty: z
		.number()
		.nullable()
		.optional()
		.transform((val) => (val === null ? undefined : val))
		.openapi({
			example: 0.0,
		}),
	response_format: z
		.union([
			z.object({
				type: z.enum(["text", "json_object"]).openapi({
					example: "json_object",
				}),
			}),
			z.object({
				type: z.literal("json_schema"),
				json_schema: z.object({
					name: z.string(),
					description: z.string().optional(),
					schema: z.record(z.any()),
					strict: z.boolean().optional(),
				}),
			}),
		])
		.optional(),
	stream: z.boolean().optional().default(false),
	tools: z
		.array(
			z.union([
				z.object({
					type: z.literal("function"),
					function: z.object({
						name: z.string(),
						description: z.string().optional(),
						parameters: z.record(z.any()).optional(),
					}),
				}),
				z.object({
					type: z.literal("web_search"),
					user_location: z
						.object({
							city: z.string().optional(),
							region: z.string().optional(),
							country: z.string().optional(),
							timezone: z.string().optional(),
						})
						.optional(),
					search_context_size: z.enum(["low", "medium", "high"]).optional(),
					max_uses: z.number().optional(),
				}),
			]),
		)
		.optional(),
	tool_choice: z
		.union([
			z.literal("auto"),
			z.literal("none"),
			z.literal("required"),
			z.object({
				type: z.literal("function"),
				function: z.object({
					name: z.string(),
				}),
			}),
		])
		.optional(),
	reasoning_effort: z
		.enum(["minimal", "low", "medium", "high"])
		.nullable()
		.optional()
		.transform((val) => (val === null ? undefined : val))
		.openapi({
			description: "Controls the reasoning effort for reasoning-capable models",
			example: "medium",
		}),
	effort: z
		.enum(["low", "medium", "high"])
		.nullable()
		.optional()
		.transform((val) => (val === null ? undefined : val))
		.openapi({
			description:
				"Controls the computational effort for supported models (currently only claude-opus-4-5-20251101)",
			example: "medium",
		}),
	free_models_only: z.boolean().optional().default(false).openapi({
		description:
			"When used with auto routing, only route to free models (models with zero input and output pricing)",
		example: false,
	}),
	no_reasoning: z.boolean().optional().default(false).openapi({
		description:
			"When used with auto routing, exclude reasoning models from selection",
		example: false,
	}),
	// Z.ai specific parameter - not documented in OpenAPI
	sensitive_word_check: z
		.object({
			status: z.enum(["DISABLE", "ENABLE"]),
		})
		.optional(),
	// Image generation config (Google and Alibaba)
	image_config: z
		.object({
			aspect_ratio: z.string().optional(),
			image_size: z.string().optional(),
			n: z.number().optional(),
			seed: z.number().optional(),
		})
		.optional(),
	// Web search enablement
	web_search: z.boolean().optional().default(false).openapi({
		description:
			"Enable native web search for models that support it. When enabled, the model can search the web for real-time information.",
		example: true,
	}),
	// Plugins configuration
	plugins: z
		.array(
			z.object({
				id: z.enum(["response-healing"]).openapi({
					description: "Plugin identifier",
					example: "response-healing",
				}),
			}),
		)
		.optional()
		.openapi({
			description:
				"Plugins to enable for this request. Currently supported: response-healing (automatically repairs malformed JSON responses when using response_format)",
			example: [{ id: "response-healing" }],
		}),
});

export type CompletionsRequest = z.infer<typeof completionsRequestSchema>;
